<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Papillons de mon jardin</title>
    <link href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        .header-section {
            background-color: white;
            position: sticky;
            top: 0;
            z-index: 100;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #2c3e50;
            margin: 0;
        }
        .header-section p {
            margin: 5px 0 0 0;
        }
        #table-container-wrapper {
            margin: 20px;
            height: calc(100vh - 120px);
        }
        #table-container {
            height: 100%;
        }
        .quality-flag {
            display: inline-block;
            width: 12px;
            height: 12px;
            margin-right: 5px;
            border: 1px solid #ccc;
            vertical-align: middle;
        }
        .research-flag {
            background-color: #74ac00;
        }
        .needsid-flag {
            background-color: #ccc;
        }
        .scientific-name {
            font-style: italic;
            color: #666;
            font-size: 0.9em;
        }
        .month-box {
            display: inline-block;
            width: 16px;
            height: 16px;
            margin: 1px;
            border: 1px solid #ddd;
            background-color: #fff;
        }
        .month-observed {
            background-color: #74ac00;
        }
        .fa-binoculars {
            color: white;
        }
        .fa-external-link {
            color: #74ac00;
        }
        .nb-obs-badge {
            font-size: 1.1em;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            padding: 0 5px;
            color: white;
            text-decoration: none;
        }
        .chrono-badge {
            background-color: #6c757d;
        }
        sup {
            font-size: 0.7em;
        }
        /* Pour les en-têtes de colonnes */
        .tabulator-header {
            position: sticky;
            top: 0;
            z-index: 10;
            background: white;
        }
        .tabulator-col {
            position: sticky;
            top: 0;
        }
        .nb-obs-link {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            justify-content: center;
        }
    </style>
</head>
<body>
    <div class="header-section">
        <h1>Papillons de mon jardin</h1>
        <p>Synthèse des observations saisies sur iNaturalist</p>
    </div>
    <div id="table-container-wrapper">
        <div id="table-container"></div>
    </div>
    <script>
        // Noms complets des mois pour les info-bulles
        const monthNames = ["Janvier", "Février", "Mars", "Avril", "Mai", "Juin", "Juillet", "Août", "Septembre", "Octobre", "Novembre", "Décembre"];

        fetch('papillons_jardin.json')
            .then(response => response.json())
            .then(data => {
                const table = new Tabulator("#table-container", {
                    data: data,
                    layout: "fitColumns",
                    responsiveLayout: "hide",
                    pagination: "local",
                    paginationSize: 500,
                    groupBy: ["groupe", "superfamily", "family"],
                    groupHeader: function(value, count, data, group) {
                        return value + " (" + count + " espèces)";
                    },
                    groupStartOpen: [true, true, true],
                    headerVisible: true,
                    height: "100%",
                    columns: [
                        {
                            title: "Nom français (et scientifique)",
                            field: "taxon_name",
                            formatter: function(cell) {
                                const rowData = cell.getRow().getData();
                                let commonName = rowData.common_name ? rowData.common_name : "";
                                let flag = "";
                                if (rowData.quality_grade === "research") {
                                    flag = `<span class="quality-flag research-flag" title="Niveau recherche"></span>`;
                                } else if (rowData.quality_grade === "needs_id") {
                                    flag = `<span class="quality-flag needsid-flag" title="Identification incertaine"></span>`;
                                }
                                const inatLink = rowData.taxon_id ? `<a href="https://www.inaturalist.org/taxa/${rowData.taxon_id}" target="_blank" style="color: inherit; margin-right: 5px;"><i class="fa fa-external-link"></i></a>` : "";
                                return flag + inatLink + commonName + (commonName && rowData.taxon_name ? " " : "") + `<span class="scientific-name">${rowData.taxon_name}</span>`;
                            }
                        },
                        {
                            title: "Chrono sps",
                            field: "sps_no",
                            hozAlign: "center",
                            headerHozAlign: "center",
                            formatter: function(cell) {
                                const spsNo = cell.getValue();
                                return spsNo ? `<span class="badge chrono-badge">${spsNo}<sup>ème</sup></span>` : "-";
                            }
                        },
                        {
                            title: "Nb. obs",
                            field: "nb_obs",
                            hozAlign: "center",
                            headerHozAlign: "center",
                            formatter: function(cell) {
                                const rowData = cell.getRow().getData();
                                const nbObs = cell.getValue();
                                const taxonId = rowData.taxon_id;
                                const url = `https://www.inaturalist.org/observations?nelat=48.395143398653566&nelng=-0.10900072866054655&place_id=any&subview=grid&swlat=48.3947159667266&swlng=-0.10986976438137175&taxon_id=${taxonId}&verifiable=any`;
                                return `<div class="nb-obs-link">
                                    <a href="${url}" target="_blank" class="badge nb-obs-badge" style="background-color: #74ac00;">
                                        <i class="fa fa-binoculars"></i><span style="margin-left: 5px;">${nbObs}</span>
                                    </a>
                                    <a href="${url}" target="_blank"><i class="fa fa-external-link"></i></a>
                                </div>`;
                            }
                        },
                        {
                            title: 'Observations <span class="badge" style="background-color: #8c8080;">min</span> et <span class="badge" style="background-color: #808c82;">max</span>',
                            field: "first_obs",
                            hozAlign: "center",
                            headerHozAlign: "center",
                            formatter: function(cell) {
                                const rowData = cell.getRow().getData();
                                const firstObs = rowData.first_obs ? new Date(rowData.first_obs) : null;
                                const lastObs = rowData.last_obs ? new Date(rowData.last_obs) : null;

                                if (!firstObs) return "-";

                                const formatDate = (date) => {
                                    const day = String(date.getDate()).padStart(2, '0');
                                    const month = String(date.getMonth() + 1).padStart(2, '0');
                                    const year = date.getFullYear();
                                    return `${day}/${month}/${year}`;
                                };

                                const firstDate = formatDate(firstObs);
                                const lastDate = lastObs ? formatDate(lastObs) : firstDate;

                                if (firstDate === lastDate) {
                                    return `<span class="badge" style="background-color: #877282;">${firstDate}</span>`;
                                } else {
                                    return `<span class="badge" style="background-color: #8c8080;">${firstDate}</span> <span class="badge" style="background-color: #808c82;">${lastDate}</span>`;
                                }
                            }
                        },
                        {
                            title: "Années",
                            field: "annees",
                            hozAlign: "center",
                            headerHozAlign: "center",
                            formatter: function(cell) {
                                const annees = cell.getValue();
                                if (!annees) return "-";
                                const anneesArray = annees.split(',').map(a => a.trim());
                                return anneesArray.map(annee => `<span class="badge" style="background-color: #74ac00;">${annee}</span>`).join(' ');
                            }
                        },
                        {
                            title: "Mois d'observation",
                            field: "mois",
                            hozAlign: "center",
                            headerHozAlign: "center",
                            formatter: function(cell) {
                                const mois = cell.getValue();
                                if (!mois) return "-";
                                const observedMonths = mois.split(',').map(m => parseInt(m.trim(), 10));
                                let boxes = [];
                                for (let m = 1; m <= 12; m++) {
                                    const isObserved = observedMonths.includes(m);
                                    const className = isObserved ? "month-box month-observed" : "month-box";
                                    boxes.push(`<span class="${className}" title="${monthNames[m-1]}"></span>`);
                                }
                                return boxes.join('');
                            }
                        },
                    ],
                    columnVisibility: {
                        "groupe": false,
                        "superfamily": false,
                        "family": false,
                        "quality_grade": false,
                    },
                });
            })
            .catch(error => {
                console.error("Erreur :", error);
                document.getElementById("table-container").innerHTML =
                    "<p style='color:red;'>Erreur : Impossible de charger le fichier JSON.</p>";
            });
    </script>
</body>
</html>
